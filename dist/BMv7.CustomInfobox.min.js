/*
* BMv7.CustomInfobox - v1.0.1 - 03-21-2013
* URL: http://russ0519.github.com/BMv7.CustomInfobox
*/

var CustomInfobox=function(t,o){function r(){d=t.getRootElement().parentNode.id+"_infobox",$("body").append("<div id='"+d+"' style='position:absolute;z-index:10000;display:none;'></div>"),n(c.tether),s(o)}function e(t){var o=["<div id='",d,"_arrow' style='position:relative;float:left;width:0;height:0;line-height:0;border-style:solid;"],r=.5*c.arrowWidth;switch(t){case 0:o.push("border-width:0 ",r,"px ",c.arrowLength,"px ",r,"px;"),o.push("border-color:transparent transparent ",c.arrowColor," transparent;");break;case 1:o.push("border-width:",r,"px 0 ",r,"px ",c.arrowLength,"px;"),o.push("border-color:transparent transparent transparent ",c.arrowColor,";");break;case 2:o.push("border-width:",c.arrowLength,"px ",r,"px 0 ",r,"px;"),o.push("border-color:",c.arrowColor," transparent transparent transparent;");break;case 3:o.push("border-width:",r,"px ",c.arrowLength,"px ",r,"px 0;"),o.push("border-color:transparent ",c.arrowColor," transparent transparent;")}return o.push("'></div>"),o.join("")}function n(t){null!=p&&Microsoft.Maps.Events.removeHandler(p),p=t?Microsoft.Maps.Events.addThrottledHandler(f,"viewchange",a,40):Microsoft.Maps.Events.addHandler(f,"viewchangestart",i)}function i(){l=null,h=null,a()}function a(){var t=$("#"+d);if(null!=t&&null!=l&&null!=h)if(f.getBounds().contains(l)){t.css("display","");var o=f.tryLocationToPixel(l,Microsoft.Maps.PixelReference.control),r=f.getPageX()+o.x,n=f.getPageY()+o.y,a=.5*f.getHeight()<o.y?2:0;a+=.5*f.getWidth()<o.x?1:0;var s,p=["<div id='",d,"_content' style='position:relative;float:left;border:1px solid ",c.borderColor,";background-color:",c.color,";min-width:",c.minWidth,"px;min-height:",c.minHeight,"px;'>",h,"</div>"],u=0,w=0;c.showArrow?c.orientation?(u=c.arrowWidth,w=c.arrowLength,s=a>1?p.join("")+e(2):e(0)+p.join("")):(u=c.arrowLength,w=c.arrowWidth,s=a%2?p.join("")+e(1):e(3)+p.join("")):s=p.join(""),t.html(s);var x=$("#"+d+"_content");c.showCloseButton&&(x.append("<span id='"+d+"_closeBtn' href='javascript:void()' style='position:absolute;right:5px;top:2px;cursor:pointer;font:bold 18px Arial;line-height:12px;'>x</span>"),$("#"+d+"_closeBtn").click(function(){i()}));var g=x.outerWidth(),v=x.outerHeight(),b=0,m=0,y=0,M=0;if(c.orientation?(b=g,m=v+w,a%2?(M=b-c.arrowWidth,r+=c.offset.x-b+.5*c.arrowWidth):r+=c.offset.x-.5*c.arrowWidth,n-=a>1?m+c.offset.y:c.offset.y):(b=u+g+2,m=Math.max(v,w),r+=a%2?c.offset.x-b:c.offset.x,a>1?(y=m-c.arrowWidth,n-=m-.5*c.arrowWidth+c.offset.y):n-=.5*c.arrowWidth+c.offset.y),c.showArrow){var W=$("#"+d+"_arrow");W.css({"margin-left":Math.ceil(M)+"px","margin-top":Math.ceil(y)+"px"})}t.css({width:Math.ceil(b)+"px",height:Math.ceil(m)+"px",top:n,left:r})}else t.css("display","none");else null!=t&&(t.html(""),t.css("display","none"))}function s(t){var o=c.tether;for(attrname in t)c[attrname]=t[attrname];o!=c.tether&&n(c.tether),a()}var h,l,d,p,f=t,c={arrowColor:"#fff",arrowLength:20,arrowWidth:30,borderColor:"#000",color:"#fff",minHeight:50,minWidth:100,offset:{x:0,y:0},orientation:0,showArrow:!0,showCloseButton:!0,tether:!1};this.hide=function(){i()},this.show=function(t,o){l=t,h=o,a()},this.getOptions=function(){return c},this.setOptions=function(t){s(t)},r()};Microsoft.Maps.moduleLoaded("CustomInfoboxModule");